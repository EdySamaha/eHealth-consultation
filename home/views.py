from django.shortcuts import render, redirect
from django.http import HttpResponse
from django.template import loader
from .forms import Register, Login
from .models import Account
import bcrypt

# Create your views here.

#region Helper functions
from hashlib import sha256

# def getJWToken():
#     redirect('token_obtain_pair')
def hashPassword(plain):
    print(plain)
    return bcrypt.hashpw(plain.encode('utf8'), bcrypt.gensalt())
    #return sha256(plain.rstrip().encode()).hexdigest()
#endregion


def index(request):
    # return render(request,'index.html')
    return render(request, 'HomePage.html')

def login(request):
    if request.method == 'POST':

        if (Account.objects.filter(username=request.POST['username']).exists()):
            user = Account.objects.filter(username=request.POST['username'])[0]
            user_pass = ""
            for i in range(2, len(user.password)-1):
                user_pass += user.password[i]
            
            temp_pass = request.POST['password']

            if (bcrypt.checkpw(temp_pass.encode('utf8'), user_pass.encode('utf8'))):
                print("correct password")
                request.session['id'] = user.user_id

            else:
                print("Incorrect username or password")
                form = Login() 
                return render(request, 'login.html', {'form':form, 'error':"Incorrect Username or Password"})
                
                
            



        #request.session.user_id = 1

        return redirect("../HomePage")
    else:
        form = Login()    
    return render(request, 'login.html', {'form':form})


def HomePage(request):
    # print(request.session['id']) #ONLY WHEN LOGGEDIN OR SIGNEDUP
    return render(request, 'HomePage.html')

def register(request):
    
    if request.method == 'POST':
        #print("register post")
        form = Register(request.POST)
        if form.is_valid():
            userform = form.cleaned_data
            # userid = userform['user_id'] #autogenerated
            username = userform['username']
            email = userform['email']
            password = hashPassword(userform['password'])
            Account.objects.create(username=username, email=email, password=password)
            
            #Render on page (Not needed for API)
            S=Account.objects.all()
            # print("type of S:",type(S))
            # getJWToken()
            #Not run:
            # return render(request, 'register.html', {'form': form,'S':S})
            #print("redirecting now")
            return redirect("../HomePage")
    else:
        #print("register get")
        form = Register()
    S= Account.objects.all()
    #print("type of S:",type(S))
    return render(request, 'register.html', {'form': form,'S':S})

'''
def login(request):
    if (User.objects.filter(email=request.POST['login_email']).exists()):
        user = User.objects.filter(email=request.POST['login_email'])[0]
        if (bcrypt.checkpw(request.POST['login_password'].encode(), user.password.encode())):
            request.session['id'] = user.id
            return redirect('/success')
    return redirect('/')

def success(request):
    user = User.objects.get(id=request.session['id'])
    context = {
        "user": user
    }
    return render(request, 'register/success.html', context)
'''